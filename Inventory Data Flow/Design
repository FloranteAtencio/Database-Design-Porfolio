--- SQL script to create tables for Inventory Management System
--- First part is Journal and Charts, second part is Inventory

CREATE TABLE IF NOT EXISTS Charts (
    ChartID SERIAL PRIMARY KEY,
    Account VARCHAR(30) NOT NULL,
    Type VARCHAR(30) NOT NULL CHECK (Type IN ('Asset', 'Liability', 'Equity', 'Revenue', 'Expense'))  
);

CREATE TABLE IF NOT EXISTS Transactions (
    TransactionID SERIAL PRIMARY KEY,
    Date DATE NOT NULL,
    Description VARCHAR(100) NOT NULL
);

CREATE TABLE IF NOT EXISTS Journals (
    JournalID SERIAL PRIMARY KEY,
    TransactionID INT,
    ChartID INT,
    Journal INT CHECK (Journal IN (0, 1)),
    Amount DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (TransactionID) REFERENCES Transactions(TransactionID),
    FOREIGN KEY (ChartID) REFERENCES Charts(ChartID)
);

--- Now creating the Inventory table which references the Charts table

CREATE TABLE IF NOT EXISTS Customers (
    CustomersID SERIAL PRIMARY KEY,
    CustomerName VARCHAR(50) NOT NULL,
    ContactInfo VARCHAR(100) NOT NULL,
    Email VARCHAR(50) NOT NULL CHECK (Email LIKE '%@%')
);

CREATE TABLE IF NOT EXISTS Suppliers (
    SupplierID SERIAL PRIMARY KEY,
    SupplierName VARCHAR(50) NOT NULL,
    ContactInfo VARCHAR(100) NOT NULL,
    Email VARCHAR(50) NOT NULL CHECK (Email LIKE '%@%')
);

CREATE TABLE IF NOT EXISTS Products (
    ProductID SERIAL PRIMARY KEY,
    Productname VARCHAR(50) NOT NULL,
    Description VARCHAR(200),
    Productsunit VARCHAR(20) NOT NULL,
    Productscost DECIMAL(10, 2) NOT NULL,
    Productsprice DECIMAL(10, 2) NOT NULL
);

CREATE TABLE IF NOT EXISTS Warehouses (
    WarehouseID SERIAL PRIMARY KEY,
    WarehouseName VARCHAR(50) NOT NULL,
    Location VARCHAR(100) NOT NULL
);

CREATE TABLE IF NOT EXISTS InventoryManagements (
    ManagementID SERIAL PRIMARY KEY,
    ProductID INT,
    WarehouseID INT,
    TransactionID INT,
    MovementType VARCHAR(50) NOT NULL CHECK (MovementType IN ('Purchase', 'Sale', 'Return', 'Transfer')),
    Quantity INT NOT NULL,
    MovementDate DATE NOT NULL,
    FOREIGN KEY (ProductID) REFERENCES Products(ProductID),
    FOREIGN KEY (WarehouseID) REFERENCES Warehouses(WarehouseID),
    FOREIGN KEY (TransactionID) REFERENCES Transactions(TransactionID)
);

-- Now creating the Accounts Payable and Accounts Receivable tables which reference the Customers and Suppliers tables respectively
CREATE TABLE IF NOT EXISTS AccountsPayable (
    PayableID SERIAL PRIMARY KEY,
    SupplierID INT,
    TransactionID INT,
    Amount DECIMAL(10, 2) NOT NULL,
    DueDate DATE NOT NULL,
    Billdate DATE NOT NULL,
    Status VARCHAR(20) NOT NULL CHECK (Status IN ('Pending', 'Paid', 'Overdue')),
    FOREIGN KEY (SupplierID) REFERENCES Suppliers(SupplierID),
    FOREIGN KEY (TransactionID) REFERENCES Transactions(TransactionID)
);

-- Accounts Receivable table which references the Customers table and Transactions table
CREATE TABLE IF NOT EXISTS AccountsReceivable (
    ReceivableID SERIAL PRIMARY KEY,
    CustomersID INT,
    TransactionID INT,
    Amount DECIMAL(10, 2) NOT NULL,
    DueDate DATE NOT NULL,
    InvoiceDate DATE NOT NULL,
    Status VARCHAR(20) NOT NULL CHECK (Status IN ('Pending', 'Paid', 'Overdue')),
    FOREIGN KEY (CustomersID) REFERENCES Customers(CustomersID),
    FOREIGN KEY (TransactionID) REFERENCES Transactions(TransactionID)
);

--General Journal

SELECT 
    t.TransactionID,
    t.Date,
    t.Description,
    c.Account,
    CASE WHEN d.Journal = 1 THEN d.Amount ELSE 0 END AS Debit,
    CASE WHEN d.Journal = 0 THEN d.Amount ELSE 0 END AS Credit
FROM Transactions t
JOIN Journal d ON t.TransactionID = d.TransactionID
JOIN Charts c ON d.ChartID = c.ChartID
ORDER BY t.Date, t.TransactionID, d.JournalLinesID;

--General Ledger

SELECT 
    c.Account,
    t.Date,
    t.Description,
    CASE WHEN d.Journal = 1 THEN d.Amount ELSE 0 END AS Debit,
    CASE WHEN d.Journal = 0 THEN d.Amount ELSE 0 END AS Credit
FROM Charts c
JOIN Journals d ON c.ChartID = d.ChartID
JOIN Transactions t ON d.TransactionID = t.TransactionID
ORDER BY c.Account, t.Date, t.TransactionID;

----Trial Balance
SELECT 
    c.Account,
    c.Type,
    SUM(CASE WHEN d.Journal = 1 THEN d.Amount ELSE 0 END) AS TotalDebit,
    SUM(CASE WHEN d.Journal = 0 THEN d.Amount ELSE 0 END) AS TotalCredit
FROM Charts c
JOIN Journals d ON c.ChartID = d.ChartID
GROUP BY c.Account, c.Type  
ORDER BY c.Type, c.Account;

---Income Statement

SELECT 
    c.Type,
    c.Account,
    SUM(CASE WHEN d.Journal = 1 THEN d.Amount ELSE 0 END) -
    SUM(CASE WHEN d.Journal = 0 THEN d.Amount ELSE 0 END) AS NetAmount
FROM Charts c
JOIN Journals d ON c.ChartID = d.ChartID    
WHERE c.Type IN ('Revenue','Expense','Cost of Goods Sold')
GROUP BY c.Type, c.Account
ORDER BY c.Type, c.Account;

--Balance Sheet

SELECT 
    c.Type,
    c.Account,
    SUM(CASE WHEN d.Journal = 1 THEN d.Amount ELSE 0 END) -
    SUM(CASE WHEN d.Journal = 0 THEN d.Amount ELSE 0 END) AS Balance
FROM Charts c
JOIN Journals d ON c.ChartID = d.ChartID    
WHERE c.Type IN ('Asset','Liability','Equity')
GROUP BY c.Type, c.Account
ORDER BY c.Type, c.Account;

---Current Stock Levels

SELECT 
    p.Productname AS Product,
    SUM(CASE WHEN im.MovementType = 'Purchase' THEN im.Quantity
             WHEN im.MovementType = 'Sale' THEN -im.Quantity
             WHEN im.MovementType = 'Adjustment' THEN im.Quantity
             ELSE 0 END) AS CurrentStock
FROM Products p
JOIN InventoryManagements im ON p.ProductID = im.ProductID
GROUP BY p.Productname;
---Inventory Valuation (at cost)
SELECT 
    p.Productname AS Product,
    SUM(CASE WHEN im.MovementType = 'Purchase' THEN im.Quantity
             WHEN im.MovementType = 'Sale' THEN -im.Quantity
             WHEN im.MovementType = 'Adjustment' THEN im.Quantity
             ELSE 0 END) * p.Cost AS InventoryValue
FROM Products p
JOIN InventoryManagements im ON p.ProductID = im.ProductID
GROUP BY p.Productname, p.Cost;
